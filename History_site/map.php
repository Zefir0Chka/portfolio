<?php
$events = [
    [
        "id" => 1,
        "title" => "Основание Рима",
        "description" => "753 г. до н.э. - легендарное основание города",
        "date" => -753,
        "period" => "ancient",
        "category" => "culture",
        "country" => "europe",
        "coordinates" => [41.9028, 12.4964],
        "image" => "images/rome.webp"
    ],
    [
        "id" => 2,
        "title" => "Битва при Каннах",
        "description" => "216 г. до н.э. - крупнейшее сражение Второй Пунической войны",
        "date" => -216,
        "period" => "ancient",
        "category" => "war",
        "country" => "europe",
        "coordinates" => [41.3000, 16.0667],
        "image" => "images/Kans_fight.jpg"
    ],
    [
        "id" => 3,
        "title" => "Крещение Руси",
        "description" => "988 г. - принятие христианства князем Владимиром",
        "date" => 988,
        "period" => "middle",
        "category" => "culture",
        "country" => "russia",
        "coordinates" => [50.4501, 30.5234],
        "image" => "images/Kreshenie.jpg"
    ],
    [
        "id" => 4,
        "title" => "Крестовые походы",
        "description" => "1096 г. - начало Первого крестового похода",
        "date" => 1096,
        "period" => "middle",
        "category" => "war",
        "country" => "europe",
        "coordinates" => [31.7683, 35.2137],
        "image" => "images/krest_wolke.webp"
    ],
    [
        "id" => 5,
        "title" => "Основание Москвы",
        "description" => "1147 г. - первое упоминание в летописях",
        "date" => 1147,
        "period" => "middle",
        "category" => "politics",
        "country" => "russia",
        "coordinates" => [55.7558, 37.6173],
        "image" => "images/moskow.webp"
    ],
    [
        "id" => 6,
        "title" => "Ледовое побоище",
        "description" => "1242 г. - битва на Чудском озере",
        "date" => 1242,
        "period" => "middle",
        "category" => "war",
        "country" => "russia",
        "coordinates" => [58.6667, 27.5000],
        "image" => "images/ise_fight.jpg"
    ],
    [
        "id" => 7,
        "title" => "Черная смерть",
        "description" => "1347 г. - начало пандемии чумы в Европе",
        "date" => 1347,
        "period" => "middle",
        "category" => "science",
        "country" => "europe",
        "coordinates" => [43.7696, 11.2558],
        "image" => "images/chuma.jpg"
    ],
    [
        "id" => 8,
        "title" => "Куликовская битва",
        "description" => "1380 г. - решающее сражение с ордой Мамая",
        "date" => 1380,
        "period" => "middle",
        "category" => "war",
        "country" => "russia",
        "coordinates" => [53.6500, 38.6500],
        "image" => "images/culek_fight.jpg"
    ],
    [
        "id" => 9,
        "title" => "Великие географические открытия",
        "description" => "XV-XVII вв. - эпоха великих открытий",
        "date" => 1492,
        "period" => "modern",
        "category" => "science",
        "country" => "europe",
        "coordinates" => [38.7223, -9.1393],
        "image" => "images/grand_geo_open.jpg"
    ],
    [
        "id" => 10,
        "title" => "Реформация",
        "description" => "1517 г. - начало Реформации",
        "date" => 1517,
        "period" => "modern",
        "category" => "culture",
        "country" => "europe",
        "coordinates" => [51.1657, 10.4515],
        "image" => "images/reforms.webp"
    ],
    [
        "id" => 11,
        "title" => "Тридцатилетняя война",
        "description" => "1618 г. - начало крупнейшего конфликта в Европе",
        "date" => 1618,
        "period" => "modern",
        "category" => "war",
        "country" => "europe",
        "coordinates" => [50.0755, 14.4378],
        "image" => "images/thetin_ages_war.jpg"
    ],
    [
        "id" => 12,
        "title" => "Основание Санкт-Петербурга",
        "description" => "1703 г. - основание новой столицы России",
        "date" => 1703,
        "period" => "modern",
        "category" => "politics",
        "country" => "russia",
        "coordinates" => [59.9343, 30.3351],
        "image" => "images/Peterburg.jpg"
    ],
    [
        "id" => 13,
        "title" => "Первая мировая война",
        "description" => "1914 г. - начало глобального конфликта",
        "date" => 1914,
        "period" => "contemporary",
        "category" => "war",
        "country" => "europe",
        "coordinates" => [50.8503, 4.3517],
        "image" => "images/World_war.jpg"
    ],
    [
        "id" => 14,
        "title" => "Великая Октябрьская революция",
        "description" => "1917 г. - революция в России",
        "date" => 1917,
        "period" => "contemporary",
        "category" => "politics",
        "country" => "russia",
        "coordinates" => [59.9343, 30.3351],
        "image" => "images/grait_october_revalushen.jpg"
    ],
    [
        "id" => 15,
        "title" => "Великая Отечественная война",
        "description" => "1941 г. - начало войны с Германией",
        "date" => 1941,
        "period" => "contemporary",
        "category" => "war",
        "country" => "russia",
        "coordinates" => [55.7558, 37.6173],
        "image" => "images/grait_otechestv_war.jpg"
    ],
    [
        "id" => 16,
        "title" => "Полет Гагарина",
        "description" => "1961 г. - первый человек в космосе",
        "date" => 1961,
        "period" => "contemporary",
        "category" => "science",
        "country" => "russia",
        "coordinates" => [45.9200, 63.3400],
        "image" => "images/gagarin.webp"
    ],
    [
        "id" => 17,
        "title" => "Распад СССР",
        "description" => "1991 г. - конец Советского Союза",
        "date" => 1991,
        "period" => "contemporary",
        "category" => "politics",
        "country" => "russia",
        "coordinates" => [55.7558, 37.6173],
        "image" => "images/USSR.jpg"
    ]
];

$currentPage = 'map';
$pageTitle = 'Историческая карта';
$isLoggedIn = false; // This should be replaced with actual login check
$userData = []; // This should be replaced with actual user data

include 'header.php';
?>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
<style>
    :root {
        --map-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        --control-bg: rgba(255, 255, 255, 0.9);
        --control-border: 1px solid rgba(0, 0, 0, 0.1);
        --control-radius: 12px;
        --transition: all 0.3s ease;
    }

    .container {
        max-width: 1400px;
        padding: 20px;
    }

    .map-container {
        height: 85vh;
        width: 100%;
        position: relative;
        border-radius: var(--control-radius);
        overflow: hidden;
        box-shadow: var(--map-shadow);
        margin-top: 20px;
        border: var(--control-border);
    }
    
    #map {
        height: 100%;
        width: 100%;
        z-index: 1;
    }

    /* Common styles for map controls */
    .map-control {
        background: var(--control-bg);
        border-radius: var(--control-radius);
        box-shadow: var(--map-shadow);
        border: var(--control-border);
        backdrop-filter: blur(10px);
        transition: var(--transition);
    }

    .map-control:hover {
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    /* Filters panel */
    .map-filters {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 1000;
        width: 300px;
        padding: 20px;
        background: var(--control-bg);
        border-radius: var(--control-radius);
        box-shadow: var(--map-shadow);
    }

    .map-filters h5 {
        color: var(--primary-color);
        font-weight: 600;
        margin-bottom: 20px;
        font-size: 1.2rem;
    }

    .form-label {
        font-weight: 500;
        color: var(--text-color);
        margin-bottom: 8px;
    }

    .form-select, .form-control {
        border-radius: 8px;
        border: 1px solid rgba(0, 0, 0, 0.1);
        padding: 10px;
        font-size: 0.95rem;
        transition: var(--transition);
    }

    .form-select:focus, .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
    }

    /* Search bar */
    .map-search {
        position: absolute;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        width: 40%;
    }

    .map-search input {
        width: 100%;
        padding: 12px 20px;
        border-radius: 30px;
        border: var(--control-border);
        background: var(--control-bg);
        box-shadow: var(--map-shadow);
        font-size: 1rem;
    }

    .map-search input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(44, 62, 80, 0.1);
    }

    /* Timeline */
    .map-timeline {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        width: 70%;
        padding: 15px 25px;
        background: var(--control-bg);
        border-radius: var(--control-radius);
        box-shadow: var(--map-shadow);
    }

    .timeline-slider {
        width: 100%;
        height: 4px;
        -webkit-appearance: none;
        background: #ddd;
        border-radius: 2px;
        outline: none;
        margin: 10px 0;
    }

    .timeline-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        background: var(--primary-color);
        border-radius: 50%;
        cursor: pointer;
        transition: var(--transition);
    }

    .timeline-slider::-webkit-slider-thumb:hover {
        transform: scale(1.2);
    }

    .timeline-labels {
        display: flex;
        justify-content: space-between;
        color: var(--text-color);
        font-weight: 500;
        font-size: 0.9rem;
    }

    /* Stats panel */
    .map-stats {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1000;
        padding: 15px;
        background: var(--control-bg);
        border-radius: var(--control-radius);
        box-shadow: var(--map-shadow);
        min-width: 200px;
    }

    .stat-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .stat-item:last-child {
        border-bottom: none;
    }

    .stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 1.2rem;
    }

    .stat-info {
        flex: 1;
    }

    .stat-value {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--primary-color);
        margin-right: 5px;
    }

    .stat-label {
        color: var(--text-color);
        font-size: 0.9rem;
    }

    /* Event popup styling */
    .event-popup {
        max-width: 300px;
        padding: 15px;
    }

    .event-popup h3 {
        color: var(--primary-color);
        font-size: 1.2rem;
        margin-bottom: 10px;
        font-weight: 600;
    }

    .event-popup img {
        width: 100%;
        height: 150px;
        object-fit: cover;
        border-radius: 8px;
        margin: 10px 0;
    }

    .event-popup p {
        color: var(--text-color);
        font-size: 0.95rem;
        line-height: 1.5;
        margin-bottom: 10px;
    }

    .badge {
        padding: 5px 10px;
        font-weight: 500;
        font-size: 0.85rem;
        margin-right: 5px;
    }

    /* Button styling */
    .btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 500;
        transition: var(--transition);
    }

    .btn-primary {
        background: var(--primary-color);
        border: none;
    }

    .btn-primary:hover {
        background: var(--secondary-color);
        transform: translateY(-2px);
    }

    .btn-secondary {
        background: #6c757d;
        border: none;
    }

    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }

    /* Responsive adjustments */
    @media (max-width: 992px) {
        .map-filters {
            width: 250px;
        }

        .map-search {
            width: 60%;
        }

        .map-timeline {
            width: 90%;
        }
    }

    @media (max-width: 768px) {
        .map-container {
            height: 70vh;
        }

        .map-filters {
            display: none;
        }

        .map-search {
            width: 80%;
        }

        .map-stats {
            display: none;
        }
    }

    /* Footer styling */
    .footer {
        background: var(--primary-color);
        color: white;
        padding: 40px 0;
        margin-top: 40px;
    }

    .footer h5 {
        font-weight: 600;
        margin-bottom: 20px;
    }

    .social-links {
        display: flex;
        gap: 15px;
    }

    .social-link {
        color: white;
        font-size: 1.5rem;
        transition: var(--transition);
    }

    .social-link:hover {
        color: var(--accent-color);
        transform: translateY(-2px);
    }
</style>
<h5>.</h5>
<h5>.</h5>
<h5>.</h5>


    <!-- Основной контент -->
    <div class="container mt-4">
        <div class="map-container">
            <div id="map"></div>
            <div class="map-filters">
                <h5>Фильтры</h5>
                <div class="mb-3">
                    <label class="form-label">Исторический период</label>
                    <select class="form-select" id="periodFilter">
                        <option value="">Все периоды</option>
                        <option value="ancient">Древний мир</option>
                        <option value="middle">Средние века</option>
                        <option value="modern">Новое время</option>
                        <option value="contemporary">Новейшее время</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Категория</label>
                    <select class="form-select" id="categoryFilter">
                        <option value="">Все категории</option>
                        <option value="politics">Политика</option>
                        <option value="culture">Культура</option>
                        <option value="science">Наука</option>
                        <option value="war">Войны</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Страна/Регион</label>
                    <select class="form-select" id="countryFilter">
                        <option value="">Все страны</option>
                        <option value="russia">Россия</option>
                        <option value="europe">Европа</option>
                        <option value="asia">Азия</option>
                        <option value="america">Америка</option>
                        <option value="africa">Африка</option>
                        <option value="australia">Австралия</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Год от</label>
                    <input type="number" class="form-control" id="yearFrom" placeholder="Начальный год">
                </div>
                <div class="mb-3">
                    <label class="form-label">Год до</label>
                    <input type="number" class="form-control" id="yearTo" placeholder="Конечный год">
                </div>
                <div class="mb-3">
                    <label class="form-label">Сортировка</label>
                    <select class="form-select" id="sortFilter">
                        <option value="date-asc">По дате (возрастание)</option>
                        <option value="date-desc">По дате (убывание)</option>
                        <option value="title-asc">По названию (А-Я)</option>
                        <option value="title-desc">По названию (Я-А)</option>
                    </select>
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="applyFilters()">Применить фильтры</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">Сбросить фильтры</button>
                </div>
            </div>
            <div class="map-search">
                <input type="text" class="form-control" id="eventSearch" placeholder="Поиск событий...">
            </div>
            <div class="map-timeline">
                <div class="timeline-labels">
                    <span id="minYear"></span>
                    <span id="maxYear"></span>
                </div>
                <input type="range" class="timeline-slider" min="-3000" max="2023" value="2023">
            </div>
            <div class="map-stats">
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="fas fa-calendar"></i>
                    </div>
                    <span class="stat-value">0</span>
                    <span class="stat-label">событий</span>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="fas fa-globe"></i>
                    </div>
                    <span class="stat-value">0</span>
                    <span class="stat-label">стран</span>
                </div>
                <div class="stat-item">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <span class="stat-value">0</span>
                    <span class="stat-label">лет истории</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Контейнер с данными событий -->
    <div id="events-data" style="display: none;" data-events='<?php echo json_encode($events); ?>'></div>

    <!-- Модальные окна -->
    <!-- Модальное окно входа -->
    <div class="modal fade" id="loginModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Вход в систему</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Пароль</label>
                            <input type="password" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Войти</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно регистрации -->
    <div class="modal fade" id="registerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Регистрация</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="registerForm">
                        <div class="mb-3">
                            <label class="form-label">Имя</label>
                            <input type="text" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Пароль</label>
                            <input type="password" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Подтверждение пароля</label>
                            <input type="password" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Зарегистрироваться</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Подвал -->
    <footer class="footer mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>О проекте</h5>
                    <p>Исторические события - это платформа для изучения и обсуждения важных исторических моментов.</p>
                </div>
                <div class="col-md-4">
                    <h5>Контакты</h5>
                    <p>Email: info@historical-events.ru</p>
                    <p>Телефон: +7 (123) 456-78-90</p>
                </div>
                <div class="col-md-4">
                    <h5>Социальные сети</h5>
                    <div class="social-links">
                        <a href="#" class="social-link"><i class="fab fa-vk"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-telegram"></i></a>
                        <a href="#" class="social-link"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // Получаем данные о событиях из HTML
        const historicalEvents = JSON.parse(document.getElementById('events-data').getAttribute('data-events'));
        
        // Инициализация карты
        const map = L.map('map').setView([55.7558, 37.6173], 4);
        
        // Добавление слоя карты
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Создание маркеров для каждого события
        historicalEvents.forEach(event => {
            const marker = L.marker(event.coordinates)
                .bindPopup(`
                    <div class="event-popup">
                        <h3>${event.title}</h3>
                        <p>${event.description}</p>
                        <img src="${event.image}" alt="${event.title}" style="width: 100%; max-width: 300px;">
                        <p>
                            <span class="badge bg-primary">${event.period}</span>
                            <span class="badge bg-secondary">${event.category}</span>
                        </p>
                    </div>
                `);
            marker.addTo(map);
        });

        // Функции фильтрации и поиска
        function applyFilters() {
            const periodFilter = document.getElementById('periodFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const countryFilter = document.getElementById('countryFilter').value;
            const yearFrom = parseInt(document.getElementById('yearFrom').value) || -3000;
            const yearTo = parseInt(document.getElementById('yearTo').value) || 2023;
            const searchText = document.getElementById('eventSearch').value.toLowerCase();

            // Очистка карты
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });

            // Применение фильтров
            historicalEvents.forEach(event => {
                if (
                    (periodFilter === '' || event.period === periodFilter) &&
                    (categoryFilter === '' || event.category === categoryFilter) &&
                    (countryFilter === '' || event.country === countryFilter) &&
                    event.date >= yearFrom &&
                    event.date <= yearTo &&
                    (searchText === '' || 
                     event.title.toLowerCase().includes(searchText) || 
                     event.description.toLowerCase().includes(searchText))
                ) {
                    const marker = L.marker(event.coordinates)
                        .bindPopup(`
                            <div class="event-popup">
                                <h3>${event.title}</h3>
                                <p>${event.description}</p>
                                <img src="${event.image}" alt="${event.title}" style="width: 100%; max-width: 300px;">
                                <p>
                                    <span class="badge bg-primary">${event.period}</span>
                                    <span class="badge bg-secondary">${event.category}</span>
                                </p>
                            </div>
                        `);
                    marker.addTo(map);
                }
            });
        }

        function resetFilters() {
            document.getElementById('periodFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('countryFilter').value = '';
            document.getElementById('yearFrom').value = '';
            document.getElementById('yearTo').value = '';
            document.getElementById('eventSearch').value = '';
            applyFilters();
        }

        // Обработчики событий
        document.getElementById('eventSearch').addEventListener('input', applyFilters);
        document.querySelector('.timeline-slider').addEventListener('input', function(e) {
            const year = parseInt(e.target.value);
            document.getElementById('yearTo').value = year;
            applyFilters();
        });

        // Обновление статистики
        function updateStats() {
            const stats = {
                events: historicalEvents.length,
                countries: new Set(historicalEvents.map(e => e.country)).size,
                years: Math.abs(Math.max(...historicalEvents.map(e => e.date)) - 
                               Math.min(...historicalEvents.map(e => e.date)))
            };

            document.querySelectorAll('.stat-value')[0].textContent = stats.events;
            document.querySelectorAll('.stat-value')[1].textContent = stats.countries;
            document.querySelectorAll('.stat-value')[2].textContent = stats.years;
        }

        updateStats();
    </script>
</body>
</html>
